@model CharityStartAtHome.Models.Blood
@{
    ViewBag.Title = "Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<ul class="breadcrumb">
    <li>@Html.ActionLink("What I can do", "Bloodm", "Bloods")</li>
    <li>@Html.ActionLink("Where I can give", "List", "Bloods")</li>
    <li style="color:black">Blood donation center </li>
</ul>

<div class="container">
    <div class="row">
        <div class="col-sx-12 text-center">
            <h1>Where to donate</h1>
            <h2>@Html.DisplayFor(model => model.Center)</h2>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-5">
            <h4 class="text-right">@Html.DisplayNameFor(model => model.Service):</h4>
        </div>
        <div class="col-sm-7">
            <label>Blood donation</label>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-5">
            <h4 class="text-right">Address: </h4>
        </div>
        <div class="col-sm-7">
            <label id="address">@Html.DisplayFor(model => model.Address)</label>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-5">
            <h4 text-right">Open hour: </h4>
        </div>
        <div class="col-sm-7">
            <label id="address">@Html.DisplayFor(model => model.Openhour)</label>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-7">
            <h4 class="text-right">@Html.DisplayNameFor(model => model.Phone):</h4>
        </div>
        <div class="col-sm-5">
            <label>@Html.DisplayFor(model => model.Phone)</label>
        </div>
    </div>

    <div id="floating-panel">
        <select id="mode" class="btn btn-success">
            <option value="DRIVING">Driving</option>
            <option value="WALKING">Walking</option>
            <option value="BICYCLING">Bicycling</option>
            <option value="TRANSIT">Transit</option>
        </select>
    </div>

    <div class="row">
        <div class="col-xs-12 text-center">
            <hr class="style-two" style="width:80%; margin-top:70px">
            <h2>Location map & Café Nearby</h2>
        </div>
        <div class="col-xs-12">
            <div id="details_map"></div>
        </div>
    </div>
</div>

<script type="text/javascript">
    // GLOBALS
    var map = null;
    var geocoder = new google.maps.Geocoder();
    var directionsDisplay = new google.maps.DirectionsRenderer;
    var directionsService = new google.maps.DirectionsService;

    // MODELS
    function Location(title, latitude, longitude, number) {
        var self = this;
        self.Title = title;
        self.Latitude = latitude;
        self.Longitude = longitude;
        self.Number = number;
    }

    // EVENTS
    $('#mode').on('change', function () {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(calculateRoute, showError, { maximumAge: 0 });
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    });

    $(document).ready(function () {

        geocoder.geocode({ 'address': address }, function (results, status) {
            if (status === 'OK') {
                map = new google.maps.Map(document.getElementById('details_map'), {
                    center: results[0].geometry.location,
                    zoom: 17
                });

                var bounds = new google.maps.LatLngBounds();
                directionsDisplay.setMap(map);
                directionsDisplay.setPanel(document.getElementById('right-panel'));

                var control = document.getElementById('floating-panel');
                control.style.display = 'block';
                map.controls[google.maps.ControlPosition.TOP_CENTER].push(control);
            } else {
                alert('Geocode was not successful for the following reason: ' + status);
            }

            var service = new google.maps.places.PlacesService(map);
            service.nearbySearch({
                location: results[0].geometry.location,
                radius: 500,
                type: ['cafe']
            }, processResults);
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(calculateRoute, showError, { maximumAge: 0 });
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    });

    // FUCNTIONS
    function MapOnPosition() {
        map = new google.maps.Map(document.getElementById('details_map'), {
            center: { lat: -34.397, lng: 150.644 },
            zoom: 8
        });
    }

    function CalculateRoute() {

        var selectedMode = $('#mode').value;
        var start = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
        var end = $("#address").text();

        directionsService.route({
            origin: start,
            destination: end,
            travelMode: selectedMode
        }, function (response, status) {
            if (status === 'OK') {
                directionsDisplay.setDirections(response);
            } else {
                window.alert('Directions request failed due to ' + status);
            }
        });       
    }

    function addUserMarker() {
        var marker = new google.maps.Marker({
            position: new google.maps.LatLng(position.coords.latitude, position.coords.longitude),
            title: "Your location",
            icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
        });

        marker.setMap(map);
    }

    function showError(error) {
        switch (error.code) {
            case error.PERMISSION_DENIED:
                console.log("User denied the request for Geolocation.");
                break;
            case error.POSITION_UNAVAILABLE:
                console.log("Location information is unavailable.");
                break;
            case error.TIMEOUT:
                console.log("The request to get user location timed out.");
                break;
            case error.UNKNOWN_ERROR:
                console.log("An unknown error occurred.");
                break;
        }
    }
</script>

